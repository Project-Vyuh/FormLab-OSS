rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ========================================
    // Helper Functions
    // ========================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidImageUrl(url) {
      return url is string && (
        url.matches('https://firebasestorage.googleapis.com/.*') ||
        url.matches('https://storage.googleapis.com/.*') ||
        url.matches('data:image/.*')
      );
    }

    // ========================================
    // Projects - Top Level Collection
    // ========================================
    match /projects/{projectId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.collaborators != null && request.auth.uid in resource.data.collaborators)
      );

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['userId', 'createdAt', 'updatedAt']);

      allow update: if isAuthenticated() && (
        // Normal update: existing userId matches authenticated user
        (resource.data.userId == request.auth.uid &&
         request.resource.data.userId == resource.data.userId) ||
        // Migration case 1: document exists but has no userId field
        (!resource.data.keys().hasAny(['userId']) &&
         request.resource.data.userId == request.auth.uid) ||
        // Migration case 2: document exists but userId is null
        (resource.data.userId == null &&
         request.resource.data.userId == request.auth.uid)
      );

      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Generated Model History - Direct collection for Create Model workflow
      match /generatedModelHistory/{historyId} {
        allow read, write: if isAuthenticated() &&
          isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.userId);

        // Validate history item structure (createdAt optional as it can be serverTimestamp)
        allow create: if request.resource.data.keys().hasAll(['type', 'imageUrl']) &&
          request.resource.data.type in ['model-generation', 'model-revision'] &&
          isValidImageUrl(request.resource.data.imageUrl);
      }

      // Styling History - Per-baseModel collections for Image Studio workflow
      // This allows dynamic collection names based on baseModelId (e.g., /projects/{projectId}/rev-123/{historyId})
      match /{baseModelId}/{historyId} {
        allow read, write: if isAuthenticated() &&
          isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.userId);

        // Validate try-on history item structure (createdAt optional)
        allow create: if request.resource.data.keys().hasAll(['type', 'imageUrl']) &&
          request.resource.data.type in ['try-on', 'try-on-revision'] &&
          isValidImageUrl(request.resource.data.imageUrl);
      }

      // Models Subcollection - Unified history for Create Model and Image Studio (legacy/alternative structure)
      match /models/{baseModelId} {
        allow read, write: if isAuthenticated() &&
          isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.userId);

        // History Subcollection - model-generation, model-revision, try-on, try-on-revision
        match /history/{historyId} {
          allow read, write: if isAuthenticated() &&
            isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.userId);

          // Validate history item structure (createdAt optional as it can be serverTimestamp)
          allow create: if request.resource.data.keys().hasAll(['type', 'imageUrl']) &&
            request.resource.data.type in ['model-generation', 'model-revision', 'try-on', 'try-on-revision'] &&
            isValidImageUrl(request.resource.data.imageUrl);
        }
      }

      // Wardrobe Subcollection
      match /wardrobe/{itemId} {
        allow read, write: if isAuthenticated() &&
          isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.userId);

        // Validate wardrobe item (relaxed for merge operations)
        allow create, update: if request.resource.data.url == null || isValidImageUrl(request.resource.data.url);
      }
    }

    // ========================================
    // User Profile Management
    // ========================================
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;

      // Global Models Collection
      match /models/{modelId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }

      // Global Wardrobe Collection
      match /wardrobe/{itemId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }

      // User Settings Collection
      match /settings/{settingId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // ========================================
    // User-Owned Content/Media Metadata
    // ========================================
    match /media/{mediaId} {
      // Allow creating new media metadata if authenticated and ownerId matches
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.ownerId;

      // Allow reading, updating, or deleting if authenticated and ownerId matches
      allow read, update, delete: if isAuthenticated() && request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // Pre-defined Content (Read-only)
    // ========================================
    match /predefined_models/{modelId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin Console or Admin SDK only
    }

    match /predefined_wardrobe/{itemId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /predefined_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ========================================
    // User Templates
    // ========================================
    match /user_templates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // Usage Tracking
    // ========================================
    match /usage/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if false; // Only Cloud Functions can write via Admin SDK
    }

    // ========================================
    // Sync Metadata
    // ========================================
    match /sync/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;

      match /devices/{deviceId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // ========================================
    // Image Upscaling Requests
    // ========================================
    match /upscale_requests/{requestId} {
      // Allow authenticated users to create their own requests
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['id', 'userId', 'imageUrl', 'resolution', 'status', 'createdAt', 'updatedAt']) &&
        request.resource.data.status == 'pending' &&
        request.resource.data.resolution in ['2k', '4k'] &&
        isValidImageUrl(request.resource.data.imageUrl);

      // Allow users to read their own requests (for real-time listener)
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Only Cloud Functions can update/delete (deny client updates)
      allow update, delete: if false;
    }

    // ========================================
    // Secure Default - Deny All
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
